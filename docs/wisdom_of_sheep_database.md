# Wisdom of Sheep Master Database Reference

The `wisdom_of_sheep.sql` SQLite database captures scraped social and news posts alongside the structured outputs generated by the council pipeline. This document describes every table, field, index, and trigger present in the master database so you can understand how content flows through the system.

## Core Content

### `posts`
Stores one row per ingested article or social post. `post_id` values are globally unique across all platforms and anchor relationships with other tables.

| Column | Type | Description |
| --- | --- | --- |
| `post_id` | `TEXT` | Primary key generated by the ingestion pipeline. Used as the foreign-key reference for dependent tables. |
| `platform` | `TEXT` | High-level source category (e.g., `reddit`, `stocktwits`, `rss`). |
| `source` | `TEXT` | More specific origin detail such as the subreddit, RSS feed identifier, or publisher tag. |
| `url` | `TEXT` | Canonical link back to the original article or post. |
| `title` | `TEXT` | Post or article headline captured at crawl time. |
| `author` | `TEXT` | Username or byline attributed to the content when available. |
| `scraped_at` | `TEXT` | Timestamp (ISO 8601 string) for when the system fetched the content. |
| `posted_at` | `TEXT` | Timestamp (ISO 8601 string) for when the content was originally published. |
| `score` | `REAL` | Platform-specific engagement metric (e.g., Reddit score). Can be `NULL` when not provided. |
| `text` | `TEXT` | Full body text that downstream stages analyse. |

### `post_extras`
Provides a flexible payload for any additional metadata that does not fit in the canonical `posts` columns.

| Column | Type | Description |
| --- | --- | --- |
| `post_id` | `TEXT` | Primary key that matches the corresponding row in `posts`. |
| `payload_json` | `TEXT` | JSON blob serialized as text. Used to store auxiliary metadata such as raw API responses or diagnostic fields. |

## Round Table Processing Outputs

### `stages`
Captures the structured JSON outputs from each council “stage” (entity extraction, claim detection, etc.). Each stage has at most one record per `post_id`.

| Column | Type | Description |
| --- | --- | --- |
| `post_id` | `TEXT` | Foreign key pointing to `posts.post_id`. |
| `stage` | `TEXT` | Stage identifier (e.g., `entity`, `summariser`, `claims`). |
| `created_at` | `TEXT` | Timestamp (ISO 8601 string) indicating when the stage output was generated. |
| `payload` | `JSON` | JSON document containing the stage’s structured result. |

*Index*: `idx_stages_post_stage_created` accelerates lookups by `post_id`, `stage`, and `created_at` when fetching the latest stage outputs.

### `bullets`
Stores the bullet-point summaries generated for a post.

| Column | Type | Description |
| --- | --- | --- |
| `post_id` | `TEXT` | Identifier tying the bullet back to the source post. |
| `bullet_text` | `TEXT` | Bullet content. This column, combined with `post_id`, forms the primary key to avoid duplicates. |
| `ticker` | `TEXT` | Optional ticker symbol associated with the bullet. |
| `created_at` | `TEXT` | Timestamp recording when the bullet was created. |

### `tickers`
Tracks every ticker symbol extracted from a post along with provenance metadata.

| Column | Type | Description |
| --- | --- | --- |
| `post_id` | `TEXT` | Foreign key referencing `posts.post_id`. |
| `ticker` | `TEXT` | Ticker symbol captured for the post. Combined with `post_id` to enforce uniqueness. |
| `market` | `TEXT` | Marketplace or exchange context (e.g., `NYSE`, `NASDAQ`). |
| `confidence` | `REAL` | Confidence score assigned by the extraction stage. |

## Full-Text Search Infrastructure

### `posts_fts`
A virtual `fts5` table that indexes post titles and body text for fast evidence retrieval. The table mirrors data from `posts` via triggers.

| Column | Type | Description |
| --- | --- | --- |
| `post_id` | `TEXT` | Unindexed identifier stored alongside the FTS row so matches can be joined back to `posts`. |
| `title` | `TEXT` | Tokenized title text. |
| `text` | `TEXT` | Tokenized article or post body. |

SQLite automatically maintains the supporting `posts_fts_data`, `posts_fts_idx`, `posts_fts_docsize`, and `posts_fts_config` tables required for `fts5` storage.

### Triggers
Three triggers keep the full-text index synchronized with the main `posts` table:

* `posts_ai` inserts new content into `posts_fts` whenever a row is added to `posts`.
* `posts_ad` deletes corresponding index entries when a post is removed.
* `posts_au` replaces the indexed content whenever a post is updated.

## Relationships Overview

* `posts` is the root entity referenced by every other logical table (`stages`, `bullets`, `tickers`, and `post_extras`).
* `stages`, `bullets`, and `tickers` can contain multiple rows per post and rely on composite primary keys to prevent duplication.
* `post_extras` provides a one-to-one extension of `posts` for auxiliary metadata.
* The `posts_fts` virtual table and its triggers keep search operations aligned with the latest `posts` content without requiring manual reindexing.
